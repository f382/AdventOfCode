#!/usr/bin/perl -w
use strict;

my $input1 = <<EOF
..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#

#..#.
#....
##..#
..#..
..###
EOF
;

my $input2 = <<EOF
####.#.#..####.#.####..#..#####.....#####.###..##.##......###.###.#.....####....####..##.##..####..........##.##...#..##..#.#.###..##...#....#...#..###.#.#####..#..#...#.####..####.#..##.#.#.###.##.##.....###..##....#....#.#.###.##.#..#..#..#######.#.##.#...#....#.....#.#..#.#.##.##.######.#..##.#..##..#####..#..###...##.#.###.#.#..###..###.....####....##...#.####.###.#.#.#..#..##.#..#.##.#.#####.####.#.#...##.####.#######...#....#####.##.#......##.######..###.###...##.##..##..#.#..####.##..#..##.#...#..#..

#..##..###.......##.##.#..##..##...#...####..#.###.#..##.#.#.#.#.##.#.##...#######..##..##.#.#..##.#
#...##....#..#####..#.#..##........#..#....##.##....#.##.##.....####...##...#..##.#....#......#...##
.#..#....#....#..##.#.##.#.##.#..#######....#.#...##..#.##.##..##.###..#...#.#.####.#..#..#####.#..#
##.#.#.....##...#..##.#..#####..#..#.####.#.##...##..#..######.#.#.#.#...#..##.###.##...#..#.#.#####
#.#.##..###...##..###......##.#.#.######.###.#.#..#.##.#.##.##..#...#..#....#.##.##....#.##...#...##
##########.....#..#..##.....#..##.#.##..##..#.##.###...#..#..##.#.#.#.###.#..##.##..###.###.#######.
...#.#...##..#.#..#..#.#.###..#....#.#.#.###..###..#......#..#.#.#.##...#..#..#.###.####.#..####...#
##..#....##.#...##..##.....#.####.##.#.#...#..######..##.#...##.####.###.#.....##...####..#......#..
##.#....###..##.##...#.#.#..#...#..###.#...#.#####.#.##..#.#.###...#####.#.###..#.##.###.#..#....#..
..#.#.......###....##.##..#.###.#..#...####...#.#.##.........#..#..##...#...#...#.##.#.#..##.#.#..#.
.###.###.########.#.##..#.....#####..#.....#..##..###....######.##.##..#..#.#####...##..##.....#.#.#
....#....##.#####..###...#..##..#.#.#.######...#.#.##.#......##.##......##..##..#.###.#..#####...##.
..##...#######..##.##.####.##.#.#.##.#.#####....#.###....###.......##########....#.#.#....##...####.
#.#..#.######....###.###.#.#######.#.....#..#.##...##..######....#....#....##.###.##......#..#.#.##.
.#...#...#....###...#######.##.#.......#..#...#...#####...##.##.....#.#..#....##..#..##...#.#.#..###
.#.#.#########..#.###.#.#.#.#....##.#####.##.#.#.......#.#.##.##...#..###...##..###..##...#....#.#.#
.#.##.#..#.#..##....##.....#.#.#.#.####.#.###..##.#...#..###....##.##..#.##..##...#......#####.#..##
####.#...##.#..#.#...####...#...#.#.####..#..#...##..#..#...#.#..##.#.#.##..#...###.###.####.#...###
...##..#..#...###.....##.####.....#...#..###..#.....################...####.###..##.####......#.##.#
..##..###.#....#......#...#.#.###..####..##...#.#..#.###..######..#.###.###.....#.##..##.#..#.#....#
.......#..#.........#............#.#..##...###.#..####..#.#..###....##....##.#..#.....#....#....#..#
.#......######....##..#.##.###..#####...##.#.#...##.#..##.#.##...#.##.##..#...#.########.#####.#...#
.....#.#.........#.###.#....#..########..####...#....##..#...#.#.#.#.#..##...#..#.###...#.########..
.#.####.##..##...#.#..###..##.#.#.#.#......#.##.#..###...#.#..###.....#..##....#.....#.#.#.#.#..#...
.#.#####.##..##.###.##.#..###....###.###...#####.#.#.#####.####..#..##.....###.......#.#..##...#####
#..#....###....#.#........###....#....#....###.....###...##.#....##....##.....##...#...##......#.###
.####.####...##.####...#..###.#..##.#..###.#......#####.#.#..#....##.###..#..#.#####.#.##..#...#..##
......#.#.#..#...#.#.......#.##..#.###.#####.#.##.######....##.#..###....#.#.#.###..##..#..#..#...##
###..#...##.###...#.#.#####....###...###.......##..#..###..#.##..###.####...######..#..#..#.#.......
##.#....###.##.#..#.#..#..###...##.....##.###.#..##...##...##.##.#......#.#...##..##...#..#.####.##.
#...#..##.#.####...##.#.#.##.####.#####....#.###.#..#..##.#.#.#...#..#.##..#..#.##.##.###..#.....#.#
.#.##....#.##....#..#.#...#.#..#####.......#..##....###...#.###.....##.###.#..###.##....#..##.##....
.#....##....##..#....####.###.#..####.##.#.########.#..#.###.#....###.####..#..#...#######....#.#.#.
#.#####...##......##.#.#.#..#.####..#..####.....#.###...#.##.#..#.####.#####..#.####...##.##.###....
....####..#..#....####.###.###.##.....#.#.#..##.##.##..###...##.......#..#.##.#...##.#....#.##......
#####...#####..###.....#...###..#.##..###...#.#..#...##..###..#......#...#...##.#.###.#####.##.#..##
##..#.######.#..#.###...##..##.#..#.#..#######..#.####..######.#......##.#...###...##..##...##....##
#..###..#..##..#..####.##..#...#.#..######.#.#######...##..##.#......##.#.##..#..######..#.#.#####.#
.###.##.##.#....#.#####...#.#.#.##...###.#.##..#.#.#..#.##.........###....#..##.....#.####....##..##
....#.###.###.#..#......###.#....#.###.#.#..##..##.#....#.#.##.#..#.#..##.#..#....#..####........##.
......#.##..###.#....#.#.#..#.####.....##..##.#..##......##..##.##...#.###.##..#.....#..........###.
####.#.#.#......###.#.####...##....#....#.#........##..#..######.#.##.####.#.###..##.#...#.##..#..#.
##....#.#.###.#.#...##..##....#...#...###.#....#.#....#..####..##....#.######.#.##.##.####.##..##.##
..#........#..###.##.#...##...#.###.#.##.#####.###.#.#..####.#.#.##..#....#.#.#.####..#....#...#.###
##...#..#.#...##....#..#.#.#......##.####.#...#........##.#.#.###...###...###........###.##.#....#.#
.##..#.####.#.##..#...##.###.#.#.#.##.####.##...#......#.#...##..........###.#....#..##..##....####.
..##..###.##.###...#.###.#..#..#...####..##..#######..#..#..#.########..#..#....##.###..#..#.#.#####
.....####..###.#.##....##.####.#....#.#.....#..#...#....######..#.####....##.#.#.#....##..####.#.###
.##.#..###......####.##.#..#.####.#.#....#.###.#..#####....#...##...######.##..####.#..##.##........
.......#.....####..#...##.###.#.#.#..#.#.....########.#.###.....####......####.#..#.....###.##...###
#..###.#....##.#....##.#..#.#.####.#.###..###.#########....#..####......##.##..##..###.##...#.#..#..
#..###.##......####.###.###.#.#.####..#...#.######..#####...##.#.##...##..#..#..#.#.##.####....#...#
#..#..#..#.#.##...#.#..##..##.#.######.##.##.####...##.#..##....##.#.##.#.###.##.####....###.##.#.#.
.#.#..##.#.#.###....#..#.#...#..###.#...##...######...####....#..####.#..#.#.##....#..#...#...#....#
.####.##...#.......#####.#.#..#.#..#...##...#.#..##.###..#....#..#..##.###.#####....###.#..#.##.####
##....###.#....#.##.#.#.#..#...##.##.....##.#....#..##...##.######..#.###.#..##..##.#.###....#...#.#
.#.##.......#....#..#....#..#.#...##...###.#.#.#.######..####..####.###.###.#.##.....#...##.##....#.
....#.###.##.#.##..#.....###..#.#......#.#####.##..#.##..#..###..#..#..#..#####..#.##.#....####.#..#
##......##.#.#..#.##...##....##..#..##.#....#.#.###.#.#..#.#####..###.#..###..##..#####..#...#.####.
#..#...#..#.#..#..#.#..#.###.#.#...#..##..#.###########.####..###.#.#..#.#.####..##..######.#.#....#
#....##..#..#####.###..###.#....#######.####.#....######.####..##.#..##.#..##.#.##....#.#####.#.###.
..###....##.#.#...##.#..#.###...#..#..#...########.#....##.###.####..#.#.##.######.#...#...##.##.#.#
.#..#.#....#.#...#.###.#...#.##.####.#.....#...###...##.##..####.#.#..####..##.###.#.#####.###..####
.#.#.##.#.#.#.#..#..#####...##..#..####.#..#.##.#.##..#..#..##.##.#.#.#######.....##.##.#....###.#.#
##.#.#...##...#.#.#.#..##.##..###.#######.####.##.#..#..####.##..#.#.###.#..###.....#..###.#.##...##
###.....####..##..##..###.##...#.##.#..##.###..##.#.##..##..#.#...##.#.#..##....#..##..#....#...####
...#.####.#...#.#.###.#.#...##....#..##.##.##.##.#...##......###...#...####..##....###.#..#..##.###.
.#.#..#.#.#..####.##..##..#..#####.#...#.#.#..#.#.....##.#.....#.......##.....#....###.##.#.#..#....
...######..#.#.####.#.#...##...#....#....##.#...###......##..#..#.##....#..###....###...##..#.#.#..#
###.####.###..#....##.###.##.#####..#.##..###.###.##.#.##.#####...#..###.#.#..##....#...#.#....###..
.#.#.#..#.############.#######.#####.##.##....####..##....####.##..#...##.###.......##.........###.#
##.#.#..##..#.##..#.#..##.#.###...#####.###.####...#..##..#.##.###...#...##.#..#.#..###.##...#...###
##.#...#.#..#.#.#.###....#.#.#.##.##.##.#.....#......###..#.#...###..##...#.##..#...###.....###..#..
.#..#.#.##..##.##.#.###.##.#.....#.#....##.#...#####....###...#.##...#..#....##.#..####..#...#.#.#.#
#.###...#...##.##.#.#.#.####.##.##.######...#..####..#.....####....#.#####....##.###.....#..#.#.#.#.
#.#.#.#....###..#.#.....#..#..##..###..#.#.#.....###..####..#.##.##.##.####....###.##.#....###..####
###.#.##.#.#.#.#..#..#.##########...####..#.#.##..##...#...#..#..#...#.#..###..#####..###.#....#####
##..####...##.....####.###..#.#######.#.##..#.#####.#....#.#....####.#.##...##....##..#.#.###.#.####
#.#.#.#.##.#.##.###.....##.#######.##.##..#####..####.#.##########.#.##.#.#....#.#.##..#..##.......#
....#.####.###...#..#####.####...#..#..##...#.....#.###...###.######.....#.#..#...#.....####..#.##..
.##.###.#....#..###.#..#.##.##.#......#.#.#.#.#.##...#.#..####.#.##.###..###...#.#.##....#..#..##...
##...####.##.#####.#....##...##...#.##..##.#.......####..#..#.#..#.#..##.#.##.#.###..#.#..###...#.##
...#####...###.#.##.#.#.#..#.#.#......#.#.####.#.#...#.....###....###.#.##.###.#.###.#.##.#.#.##.#.#
##.#.##.#.#.#####....###.#...##.###..##.###....#####..#.###.##.##.##.##...#.#.#.###.#..##.#...#.....
...####.#..#..#..#.#...###..##..###.#.###.##.##.####.#.#.#......#####...##.#..#.##.##.#.....#....##.
..#.#..###.#....##....#.#.#..#####.##.##.####..##..#....####..##..####.##.#######......#.#.#..#.##..
#.###.#.#.##.#.##..##.#..#.#######..#...#..##..##..##..##....##..####.##..#.#..#.....##.##.####..#.#
..##..#..##..##.##.###.##..#####...#..###..####...##..#.....###..#.#.##....##....##.#.##..#.....#..#
...#.##..###..#.#.#####..#...#.#.#..#..###.#.#.#.#........#..##..###......#..#.##.#..#.#...###.#.##.
#.##...#.#.#...##.......#...#..##...#.#..##...##.#....###.###.#.###...#........###.#####.#.##....##.
#.##..#......####..#....###..#.#..########.......#.####...#......######..#...#####.#.#.......#####.#
##.##..##.##.###.##.#.....#..##.#.#...###.......##.#.#...........#..#..##.#.##.#.###.#.###.##..#...#
...#.#####.##.#.....##..##.##.#..#.#....#.#####.######....####..#..##..#.#.#......##...#.#....##.#..
#.#####.#.###..##.#.##...#.#.###.#####.....#.##..##.##..#.##...##.##..########..#..#..###..#.#..####
..##.##.....#..#####.##..####.##...#...##.##..#..##.#.######.#.#..###...###...###.##..###....###.##.
##.##...#.####.#..#..#.#.#..#...##.#.....##.###.##.###.#.#..##.#.#.....#..#.###.###..#.#..#####.#...
.###......##..##.#..#......###.##...#..#..........##..#...#..######.#.#.....##....##.##.##.#.##..##.
#..##.#..##.##..#####......#.#..###..#.#....#.###..###..##.#.##..###..#.#.###..####.###..#.#....###.
..#..#####..#.#...##.##.##.#.#.#####...#...####.....##.##..#..#....#..#.....#......####.#....#.####.
.#.##.##...###...##.#....####..#####.##.#..#...##.#########.#..#..#.#.##.####.##########...#####..#.
EOF
;

#################
my $input = $input2;

sub clone {
	return map { [ map { $_[0][0] } @$_ ] } @_;
}

sub enlarge {
	my($pic, $o) = @_;
	$o //= $pic->[0][0];
	unshift @$pic, [ map { $o } @{$pic->[0]} ];
	unshift @$pic, [ map { $o } @{$pic->[0]} ];
	push @$pic, [ map { $o } @{$pic->[@$pic - 1]} ];
	push @$pic, [ map { $o } @{$pic->[@$pic - 1]} ];
	for (my $i = 0; $i < @$pic; ++$i) {
		unshift @{$pic->[$i]}, $o;
		unshift @{$pic->[$i]}, $o;
		push @{$pic->[$i]}, $o;
		push @{$pic->[$i]}, $o;
	}
}

sub extract {
	my($pic, $algo, $x, $y) = @_;
	my $number = "";
	for (my $i = -1; $i <= 1; ++$i) {
		for (my $j = -1; $j <= 1; ++$j) {
			my $p = $x + $i;
			my $q = $y + $j;
			my $d = $pic->[0][0];
			if ($p >= 0 && $p < @$pic && $q >= 0 && $q < @{$pic->[$p]}) {
				$d = $pic->[$p][$q];
			}
			$number .= $d;
		}
	}
	return oct('0b' . $number);
}

sub process {
	my($pic, $algo) = @_;
	enlarge($pic);
	my @new = clone(@$pic);
	# print join("\n", map { join("", @$_ ) } @$pic), "\n\n";
	# print join("\n", map { join("", @$_ ) } @new), "\n\n";
	for (my $i = 0; $i < @$pic; ++$i) {
		for (my $j = 0; $j < @{$pic->[$i]}; ++$j) {
			my $k = extract($pic, $algo, $i, $j);
			my $v = $algo->[$k];
			# print "$i, $j -> $k: $v\n";
			$new[$i][$j] = $v;
		}
	}
	# print join("\n", map { join("", @$_ ) } @new), "\n\n";
	# exit;
	return @new;
}

sub sumsum {
	my $s = 0;
	foreach my $v (@_) {
		my $t = ref($v) ? sumsum(@$v) : $v;
		$s += $t;
	}
	return $s;
}

$input =~ /^([#.]+)\s+((?:[#.]+\s*)*)$/ or die;
my($algo, $start) = ($1, $2);
chomp $start;

my @map = map { $_ eq '#' ? 1 : 0 } split '', $algo;
my @pic = map { [ map { $_ eq '#' ? 1 : 0 } split '', $_ ] } split /\s+/, $start;

print join("", @map), "\n\n\n";
print join("\n", map { join("", @$_ ) } @pic), "\n\n";

enlarge(\@pic, 0);
enlarge(\@pic, 0);
print join("\n", map { join("", @$_ ) } @pic), "\n\n";

@pic = process(\@pic, \@map);
print join("\n", map { join("", @$_ ) } @pic), "\n\n";

@pic = process(\@pic, \@map);
print join("\n", map { join("", @$_ ) } @pic), "\n\n";

my $s = sumsum(@pic);
print "$s\n";
